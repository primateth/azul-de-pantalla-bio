<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bibliograf√≠a Azul de Pantalla ¬∑ Templo del dato</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1620;
      --panel2:#121c28;
      --text:#e9eef6;
      --muted:#a7b3c6;
      --accent:#0b4dff; /* Klein-ish */
      --accent2:#2bd4ff;
      --border:rgba(255,255,255,.10);
      --shadow:0 18px 40px rgba(0,0,0,.38);
      --radius:18px;
      --radius2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:radial-gradient(1200px 800px at 20% 0%, rgba(11,77,255,.15), transparent 60%),
                 radial-gradient(900px 700px at 90% 10%, rgba(43,212,255,.10), transparent 55%),
                 var(--bg);
      color:var(--text);
    }
    a{color:var(--accent2); text-decoration:none}
    a:hover{text-decoration:underline}
    .top{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,15,20,.92), rgba(11,15,20,.70));
      border-bottom:1px solid var(--border);
    }
    .topInner{
      max-width:1200px; margin:0 auto; padding:18px 18px 14px;
      display:flex; gap:16px; align-items:flex-start; justify-content:space-between;
    }
    .titleWrap{min-width:260px}
    h1{
      font-size:18px; margin:0 0 6px 0; letter-spacing:.2px;
    }
    .sub{
      margin:0; color:var(--muted); font-size:13px; line-height:1.35;
    }
    .quote{
      margin:10px 0 0; color:rgba(233,238,246,.85);
      font-size:13px; line-height:1.45;
      border-left:3px solid rgba(11,77,255,.55);
      padding-left:10px;
    }
    .btnRow{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
      align-items:center;
      margin-top:2px;
    }
    .btn{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(18,28,40,.95), rgba(15,22,32,.75));
      color:var(--text);
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      font-size:13px;
      display:inline-flex; gap:8px; align-items:center;
      user-select:none;
    }
    .btn:hover{border-color:rgba(255,255,255,.18)}
    .btn.primary{
      border-color:rgba(11,77,255,.55);
      background: linear-gradient(180deg, rgba(11,77,255,.32), rgba(15,22,32,.75));
    }
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .layout{
      max-width:1200px;
      margin:0 auto;
      padding:16px 18px 30px;
      display:grid;
      grid-template-columns: 330px 1fr;
      gap:16px;
    }
    .card{
      background: linear-gradient(180deg, rgba(15,22,32,.92), rgba(12,18,26,.88));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .side{
      position:sticky; top:110px;
      height: calc(100vh - 130px);
      overflow:auto;
    }
    .sideInner{padding:14px}
    .label{font-size:12px; color:var(--muted); margin:12px 0 6px}
    .input, .select, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(18,28,40,.55);
      color:var(--text);
      font-size:13px;
      outline:none;
    }
    textarea{
      min-height:130px;
      font-family:var(--mono);
      font-size:12px;
      line-height:1.35;
      resize:vertical;
    }
    .row{display:flex; gap:10px}
    .row > *{flex:1}
    .small{font-size:12px; color:var(--muted); line-height:1.4}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(18,28,40,.35);
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
    }
    .main{
      overflow:hidden;
    }
    .mainInner{padding:16px}
    .toolbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      padding:14px 14px 0;
    }
    .status{
      font-family:var(--mono);
      font-size:12px;
      color:rgba(233,238,246,.75);
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(18,28,40,.25);
    }
    .hr{
      height:1px; background:var(--border);
      margin:14px 0;
    }
    details{
      border:1px solid var(--border);
      border-radius: var(--radius2);
      background: rgba(18,28,40,.25);
      margin:10px 0;
      overflow:hidden;
    }
    summary{
      cursor:pointer;
      padding:12px 12px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      list-style:none;
    }
    summary::-webkit-details-marker{display:none}
    .sumLeft{
      display:flex; gap:10px; align-items:baseline; flex-wrap:wrap;
    }
    .who{font-weight:650; letter-spacing:.2px}
    .refRange{
      font-family:var(--mono);
      font-size:12px;
      color:rgba(233,238,246,.72);
      border:1px solid rgba(255,255,255,.12);
      padding:4px 8px;
      border-radius:999px;
      background: rgba(11,77,255,.10);
    }
    .blockBody{padding:0 12px 12px}
    ul.entries{margin:8px 0 0 0; padding:0 0 0 18px}
    ul.entries li{margin:6px 0; color:rgba(233,238,246,.90); line-height:1.45}
    .ref{
      font-family:var(--mono);
      font-size:12px;
      color:rgba(233,238,246,.75);
      margin-right:6px;
    }
    .metaLine{
      font-family:var(--mono);
      font-size:12px;
      color:rgba(167,179,198,.92);
      margin-top:8px;
    }
    .secTitle{
      margin:18px 0 6px;
      font-size:15px;
      color:rgba(233,238,246,.92);
      letter-spacing:.2px;
    }
    .subTitle{
      margin:14px 0 6px;
      font-size:13px;
      color:rgba(233,238,246,.88);
      letter-spacing:.2px;
    }
    .hint{
      font-size:12px;
      color:rgba(167,179,198,.95);
      line-height:1.45;
      margin-top:8px;
    }
    .tag{
      font-family:var(--mono);
      font-size:11px;
      color:rgba(167,179,198,.9);
      border:1px solid rgba(255,255,255,.10);
      padding:3px 8px;
      border-radius:999px;
      background: rgba(18,28,40,.25);
    }
    .sepOpt{
      color:rgba(167,179,198,.7);
    }

    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      .side{position:relative; top:auto; height:auto}
      .topInner{flex-direction:column; align-items:stretch}
      .btnRow{justify-content:flex-start}
    }
  </style>
</head>
<body>
  <div class="top">
    <div class="topInner">
      <div class="titleWrap">
        <h1>Bibliograf√≠a Azul de Pantalla ¬∑ <span class="tag">Templo del dato</span></h1>
        <p class="sub">√çndice navegable (autores A‚ÄìZ primero, secciones a√±adidas al final). Normaliza subrefs <span style="font-family:var(--mono)">REF-XXX_X</span> ‚Üí <span style="font-family:var(--mono)">REF-XXX-YY</span>.</p>
        <div class="quote">
          <div>Quiz√°s es mejor la bibliograf√≠a que el propio libro.</div>
          <div>Si el libro es malo, la bibliograf√≠a siempre queda bien.</div>
          <div>Si el libro es bueno, la bibliograf√≠a se atribuye el m√©rito.</div>
          <div style="opacity:.75;margin-top:6px">¬© M. M√úLLER</div>
        </div>
      </div>

      <div class="btnRow">
        <button class="btn primary" id="btnTop" title="Volver arriba">‚Üë Arriba</button>
        <button class="btn" id="btnCopyAnchor" title="Copia el enlace interno a la secci√≥n actual">‚õì Copiar ancla</button>
        <a class="btn" href="mailto:mercurius81@proton.me" title="Contacto por email">‚úâ Contacto</a>
        <button class="btn" id="btnComprar" disabled title="Sin link de compra todav√≠a">üõí Comprar</button>
      </div>
    </div>
  </div>

  <div class="layout">
    <aside class="card side">
      <div class="sideInner">
        <div class="label">Cargar bibliograf√≠a</div>
        <div class="row">
          <input class="input" type="file" id="fileInput" accept=".txt,.md,.text" />
          <button class="btn" id="btnLoadDemo" title="Carga un ejemplo m√≠nimo para probar">‚öô Demo</button>
        </div>
        <div class="label">O pegar texto (y ‚ÄúProcesar‚Äù)</div>
        <textarea id="pasteBox" placeholder="Pega aqu√≠ tu bibliograf√≠a completa (tal cual) y pulsa ‚ÄúProcesar‚Äù‚Ä¶"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnProcess">‚ö° Procesar</button>
          <button class="btn" id="btnClear">üßΩ Limpiar</button>
        </div>

        <div class="hr"></div>

        <div class="label">Buscar (autor / secci√≥n)</div>
        <input class="input" id="search" placeholder="Ej: Foucault, REF-152, Podcasts‚Ä¶" />

        <div class="label">Ir a (autores primero, secciones al final)</div>
        <select class="select" id="jumpSelect">
          <option value="">(elige‚Ä¶)</option>
        </select>

        <div class="pill" id="countsPill">Sin datos cargados</div>

        <p class="hint">
          Consejo Scribus: si en tu TXT tienes <span style="font-family:var(--mono)">REF-017_1</span>, aqu√≠ se ver√° como
          <span style="font-family:var(--mono)">REF-017-01</span> para evitar p√©rdidas/orden raro en men√∫s.
        </p>
      </div>
    </aside>

    <main class="card main">
      <div class="toolbar">
        <div class="status" id="status">Crea el √≠ndice cargando tu TXT o pegando el texto.</div>
      </div>
      <div class="mainInner" id="content"></div>
    </main>
  </div>

<script>
/* ============
   Normalizaci√≥n REF: REF-123_1 => REF-123-01
   ============ */
function normalizeRef(refToken){
  // refToken viene como "REF-017_1" o "REF-017" o "REF-017-01"
  const m = refToken.match(/^REF-(\d{3})(?:[_-](\d+))?$/);
  if(!m) return refToken;
  const main = m[1];
  const sub = m[2];
  if(!sub) return `REF-${main}`;
  const sub2 = String(parseInt(sub,10)).padStart(2,'0');
  return `REF-${main}-${sub2}`;
}

function parseRefFromLine(line){
  // Match "REF-123." or "REF-123_1." or "REF-123-01."
  const m = line.match(/^(REF-\d{3}(?:[_-]\d+)?)\.\s*(.*)$/);
  if(!m) return null;
  return { rawRef:m[1], ref: normalizeRef(m[1]), text: m[2].trim() };
}

function slugify(s){
  return s
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[^\w\s-]/g,"")
    .trim()
    .replace(/\s+/g,"-")
    .replace(/-+/g,"-");
}

function looksLikeSectionHeading(title){
  const T = title.trim();
  const known = new Set([
    "PODCASTS",
    "AUDIOLIBROS",
    "IVOOX / PROGRAMAS",
    "BLOGS",
    "MANUALES",
    "EPIC GAMES",
    "TEXTOS RELIGIOSOS",
    "IDEOLOG√çAS / DOCTRINAS DE MANDO (POL√çTICA Y R√âGIMEN)",
    "IDEOLOG√çAS (CARTOGRAF√çA HIST√ìRICA)",
    "CONTRAPESOS / HISTORIOGRAF√çA CR√çTICA",
    "ANTI-TECNOLOG√çA (OBJETOS HIST√ìRICOS)",
    "CR√çTICA DE LA T√âCNICA (CANON)",
    "RADICALISMOS ANTI-CIVILIZACI√ìN (CARTOGRAF√çA)"
  ]);
  if(known.has(T)) return true;

  // Heur√≠stica: todo may√∫sculas largo, o con barras/par√©ntesis muy ‚Äúsecci√≥n‚Äù
  const isAllCaps = (T === T.toUpperCase()) && /[A-Z√Å√â√ç√ì√ö√ú√ë]/.test(T);
  if(isAllCaps && T.length >= 8 && !T.includes(",")) return true;
  if(T.includes(" / ") && (T === T.toUpperCase())) return true;
  if(/\(.+\)/.test(T) && (T === T.toUpperCase())) return true;

  return false;
}

function isIgnorableLine(line){
  const t = line.trim();
  if(!t) return true;
  const ignoreStarts = [
    "Bibliograf√≠a Azul de pantalla",
    "Templo del dato",
    "Quiz√°s es mejor",
    "Si el libro es malo",
    "Si el libro es bueno",
    "¬©"
  ];
  return ignoreStarts.some(x => t.startsWith(x));
}

function parseBibliography(raw){
  const lines = raw.split(/\r?\n/);

  const blocks = [];
  let current = null;

  function pushCurrent(){
    if(current){
      blocks.push(current);
      current = null;
    }
  }

  for(let i=0;i<lines.length;i++){
    const line = lines[i].trim();
    if(isIgnorableLine(line)) continue;

    const ref = parseRefFromLine(line);
    if(ref){
      if(!current){
        // si aparece REF sin encabezado, crea bloque gen√©rico
        current = { title: "SIN ENCABEZADO", kind: "author", entries:[], links:[] };
      }
      current.entries.push(ref);
      continue;
    }

    // Links / PDF / URLs sueltas
    const linkMatch = line.match(/^(Link:|PDF:)\s*(.+)$/i);
    if(linkMatch){
      if(!current){
        current = { title: "ENLACES", kind:"section", entries:[], links:[] };
      }
      current.links.push(linkMatch[2].trim());
      continue;
    }

    // URL sola (l√≠nea entera)
    if(/^https?:\/\/\S+$/i.test(line)){
      if(!current){
        current = { title: "ENLACES", kind:"section", entries:[], links:[] };
      }
      current.links.push(line);
      continue;
    }

    // Nuevo encabezado
    pushCurrent();
    const title = line;
    const kind = looksLikeSectionHeading(title) ? "section" : "author";
    current = { title, kind, entries:[], links:[] };
  }
  pushCurrent();

  // Post-proceso: asignar ids √∫nicos y calcular rango REF
  const usedIds = new Map();
  for(const b of blocks){
    const base = (b.kind==="author" ? "a-" : "s-") + slugify(b.title || "bloque");
    const count = (usedIds.get(base) || 0) + 1;
    usedIds.set(base, count);
    b.id = count===1 ? base : `${base}-${count}`;

    if(b.entries.length){
      b.firstRef = b.entries[0].ref;
      b.lastRef = b.entries[b.entries.length-1].ref;
      b.refLabel = (b.firstRef === b.lastRef) ? b.firstRef : `${b.firstRef}‚Äì${b.lastRef}`;
    } else if(b.links.length){
      b.refLabel = "links";
    } else {
      b.refLabel = "";
    }
  }

  return blocks;
}

function render(blocks){
  const content = document.getElementById("content");
  content.innerHTML = "";

  // Separa autores y secciones, pero el contenido se renderiza en el orden original
  const authorBlocks = blocks.filter(b => b.kind==="author");
  const sectionBlocks = blocks.filter(b => b.kind==="section");

  // Jump select: autores (A‚ÄìZ) primero, luego secciones (en orden de aparici√≥n)
  const jump = document.getElementById("jumpSelect");
  jump.innerHTML = `<option value="">(elige‚Ä¶)</option>`;

  const collator = new Intl.Collator("es", { sensitivity:"base", numeric:true });
  const authorsSorted = [...authorBlocks].sort((x,y)=>{
    const c = collator.compare(x.title, y.title);
    if(c!==0) return c;
    return collator.compare(x.refLabel||"", y.refLabel||"");
  });

  const optgroupA = document.createElement("optgroup");
  optgroupA.label = "AUTORES (A‚ÄìZ)";
  for(const b of authorsSorted){
    const opt = document.createElement("option");
    opt.value = b.id;
    const ref = b.refLabel ? ` ‚Äî ${b.refLabel}` : "";
    opt.textContent = `${b.title}${ref}`;
    optgroupA.appendChild(opt);
  }
  jump.appendChild(optgroupA);

  const optgroupS = document.createElement("optgroup");
  optgroupS.label = "SECCIONES (al final)";
  // Secciones: solo ‚Äúmacro‚Äù (las que suelen ser tus cabeceras finales)
  // Mantiene orden de aparici√≥n
  const seen = new Set();
  for(const b of sectionBlocks){
    // Filtra duplicados exactos por t√≠tulo (para no repetir demasiado)
    const key = b.title.trim();
    if(seen.has(key)) continue;
    seen.add(key);
    const opt = document.createElement("option");
    opt.value = b.id;
    opt.textContent = b.title;
    optgroupS.appendChild(opt);
  }
  jump.appendChild(optgroupS);

  // Render en orden original, con niveles visuales
  for(const b of blocks){
    const wrapper = document.createElement("div");
    wrapper.id = b.id;

    // ‚ÄúSecci√≥n‚Äù grande: H2
    if(b.kind === "section"){
      const h = document.createElement("div");
      h.className = "secTitle";
      h.textContent = b.title;
      wrapper.appendChild(h);

      if(b.links.length){
        const p = document.createElement("div");
        p.className = "metaLine";
        p.innerHTML = b.links.map(u => `‚Ä¢ <a href="${escapeHtml(u)}" target="_blank" rel="noopener noreferrer">${escapeHtml(u)}</a>`).join("<br>");
        wrapper.appendChild(p);
      }

      if(b.entries.length){
        const ul = document.createElement("ul");
        ul.className = "entries";
        for(const e of b.entries){
          const li = document.createElement("li");
          li.innerHTML = `<span class="ref">${escapeHtml(e.ref)}.</span> ${escapeHtml(e.text)}`;
          ul.appendChild(li);
        }
        wrapper.appendChild(ul);
      }

      content.appendChild(wrapper);
      continue;
    }

    // Autor: acorde√≥n
    const details = document.createElement("details");
    details.open = false;
    const summary = document.createElement("summary");

    const left = document.createElement("div");
    left.className = "sumLeft";
    const who = document.createElement("div");
    who.className = "who";
    who.textContent = b.title;

    const ref = document.createElement("div");
    ref.className = "refRange";
    ref.textContent = b.refLabel || "‚Äî";

    left.appendChild(who);
    left.appendChild(ref);

    const right = document.createElement("div");
    right.style.opacity = ".75";
    right.style.fontSize = "12px";
    right.textContent = "ver";

    summary.appendChild(left);
    summary.appendChild(right);

    const body = document.createElement("div");
    body.className = "blockBody";

    if(b.entries.length){
      const ul = document.createElement("ul");
      ul.className = "entries";
      for(const e of b.entries){
        const li = document.createElement("li");
        li.innerHTML = `<span class="ref">${escapeHtml(e.ref)}.</span> ${escapeHtml(e.text)}`;
        ul.appendChild(li);
      }
      body.appendChild(ul);
    }

    if(b.links.length){
      const p = document.createElement("div");
      p.className = "metaLine";
      p.innerHTML = b.links.map(u => `‚Ä¢ <a href="${escapeHtml(u)}" target="_blank" rel="noopener noreferrer">${escapeHtml(u)}</a>`).join("<br>");
      body.appendChild(p);
    }

    details.appendChild(summary);
    details.appendChild(body);

    const card = document.createElement("div");
    card.className = "card";
    card.style.padding = "0";
    card.style.background = "transparent";
    card.style.border = "0";
    card.style.boxShadow = "none";
    card.appendChild(details);

    wrapper.appendChild(card);
    content.appendChild(wrapper);
  }

  // Estado + contadores
  const countsPill = document.getElementById("countsPill");
  countsPill.textContent = `${authorBlocks.length} autores ¬∑ ${sectionBlocks.length} secciones/bloques ¬∑ ${blocks.length} bloques total`;

  document.getElementById("status").textContent =
    `Cargado: ${authorBlocks.length} autores (navegables A‚ÄìZ) ¬∑ secciones finales incluidas. Subrefs normalizadas a REF-XXX-YY.`;
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ============
   B√∫squeda / navegaci√≥n
   ============ */
function setupSearch(){
  const search = document.getElementById("search");
  const jump = document.getElementById("jumpSelect");

  search.addEventListener("input", ()=>{
    const q = search.value.trim().toLowerCase();
    const opts = jump.querySelectorAll("option");
    for(const opt of opts){
      if(!opt.value) continue;
      opt.hidden = q ? !opt.textContent.toLowerCase().includes(q) : false;
    }
  });

  jump.addEventListener("change", ()=>{
    const id = jump.value;
    if(!id) return;
    const el = document.getElementById(id);
    if(!el) return;
    el.scrollIntoView({behavior:"smooth", block:"start"});
    // abre el acorde√≥n si es autor
    const det = el.querySelector("details");
    if(det) det.open = true;
  });
}

function setupButtons(){
  document.getElementById("btnTop").addEventListener("click", ()=>{
    window.scrollTo({top:0, behavior:"smooth"});
  });

  document.getElementById("btnClear").addEventListener("click", ()=>{
    document.getElementById("pasteBox").value = "";
    document.getElementById("content").innerHTML = "";
    document.getElementById("jumpSelect").innerHTML = `<option value="">(elige‚Ä¶)</option>`;
    document.getElementById("status").textContent = "Limpio. Carga un TXT o pega el texto.";
    document.getElementById("countsPill").textContent = "Sin datos cargados";
  });

  document.getElementById("btnCopyAnchor").addEventListener("click", async ()=>{
    const id = getNearestAnchorId();
    if(!id){
      alert("No encuentro ancla cerca (haz scroll a un bloque).");
      return;
    }
    const anchor = `#${id}`;
    try{
      await navigator.clipboard.writeText(anchor);
      alert(`Copiado: ${anchor}`);
    }catch{
      prompt("Copia manual:", anchor);
    }
  });

  document.getElementById("btnLoadDemo").addEventListener("click", ()=>{
    const demo = `
Bibliograf√≠a Azul de pantalla
Templo del dato

AGAMBEN, Giorgio
REF-001. El Reino y la Gloria. (2008).
REF-002. Signatura rerum. (2008).

PODCASTS
AUDIOLIBROS
REF-295. El informe de Iron Mountain: sobre la posibilidad y conveniencia de la paz. (Audiolibro).

MANUALES
EPIC GAMES
REF-303. Unreal Engine 5.7 Documentation. Epic Developer Community.
    `.trim();
    document.getElementById("pasteBox").value = demo;
    document.getElementById("btnProcess").click();
  });

  document.getElementById("btnProcess").addEventListener("click", ()=>{
    const raw = document.getElementById("pasteBox").value;
    if(!raw.trim()){
      alert("Pega tu bibliograf√≠a o carga un .txt primero.");
      return;
    }
    const blocks = parseBibliography(raw);
    render(blocks);
  });

  document.getElementById("fileInput").addEventListener("change", async (ev)=>{
    const file = ev.target.files && ev.target.files[0];
    if(!file) return;
    const text = await file.text();
    document.getElementById("pasteBox").value = text;
    document.getElementById("btnProcess").click();
  });
}

function getNearestAnchorId(){
  // Busca el bloque visible m√°s cercano al top
  const content = document.getElementById("content");
  const blocks = Array.from(content.children);
  const top = window.scrollY + 140; // margen por header
  let best = null;
  let bestDist = Infinity;
  for(const b of blocks){
    const r = b.getBoundingClientRect();
    const y = window.scrollY + r.top;
    const d = Math.abs(y - top);
    if(d < bestDist){
      bestDist = d;
      best = b;
    }
  }
  return best && best.id ? best.id : null;
}

/* init */
setupSearch();
setupButtons();
</script>
</body>
</html>
