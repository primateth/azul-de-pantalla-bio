<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Azul de Pantalla · Bibliografía</title>
  <meta name="description" content="Bibliografía de Azul de Pantalla. Si no te carga, no existes." />
  <meta name="theme-color" content="#0b0c22" />
  <style>
    :root{ color-scheme: dark; --bg:#050616; --panel:rgba(18,20,56,.35); --panel2:rgba(10,12,34,.55);
      --border:rgba(110,130,255,.22); --text:#e9ecff; --muted:rgba(233,236,255,.72); --link:#6aa2ff; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); line-height:1.55; }
    a{ color:var(--link); text-decoration:none; } a:hover{ text-decoration:underline; }
    .wrap{ max-width:1100px; margin:0 auto; padding:34px 18px 60px; }
    .top{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .badge{ display:inline-flex; align-items:center; gap:10px; padding:8px 12px; border:1px solid var(--border);
      border-radius:999px; background:var(--panel2); letter-spacing:.6px; text-transform:uppercase; font-size:13px; }
    .dot{ width:8px; height:8px; border-radius:999px; background:#2b3cff; box-shadow:0 0 0 4px rgba(43,60,255,.15); }
    h1{ margin:14px 0 6px; font-size:40px; }
    .sub{ margin:0 0 16px; color:var(--muted); max-width:80ch; }
    .card{ margin-top:14px; padding:16px; border:1px solid var(--border); border-radius:18px; background:var(--panel); }
    .quote{ border-left:3px solid rgba(106,162,255,.55); padding-left:12px; margin:12px 0; color:rgba(233,236,255,.86); }
    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace; font-size:13px; color:rgba(233,236,255,.78); }
    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    input[type="search"]{ width:min(540px,100%); padding:10px 12px; border-radius:12px; border:1px solid rgba(110,130,255,.28);
      background:rgba(10,12,34,.55); color:var(--text); outline:none; }
    input[type="search"]::placeholder{ color:rgba(233,236,255,.5); }
    .stats{ color:var(--muted); font-size:13px; }
    .toc{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .pill{ padding:6px 10px; border:1px solid rgba(110,130,255,.22); border-radius:999px; background:rgba(10,12,34,.35); font-size:12px; color:rgba(233,236,255,.82); }
    details{ border:1px solid rgba(110,130,255,.18); border-radius:16px; background:rgba(10,12,34,.25); padding:10px 12px; margin:10px 0; }
    summary{ cursor:pointer; list-style:none; }
    summary::-webkit-details-marker{ display:none; }
    .sumline{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .author{ font-weight:700; letter-spacing:.2px; }
    .count{ color:var(--muted); font-size:13px; }
    ol{ margin:10px 0 0; padding-left:18px; }
    li{ margin:8px 0; }
    .ref{ display:inline-block; min-width:84px; }
    .hide{ display:none !important; }
  </style>
</head>
<body>
  <div class="wrap" id="top">
    <div class="top">
      <div class="badge"><span class="dot"></span><span>Azul de Pantalla · Bibliografía</span></div>
      <div class="mono">Ruta: <span class="mono">/bibliografia.txt</span> · Clasificación: ABIERTA</div>
    </div>

    <h1>Bibliografía</h1>
    <p class="sub">
      Si el libro es malo, la bibliografía siempre queda bien. Si el libro es bueno, la bibliografía se atribuye el mérito.
      Este sitio solo cumple una función: que la lista cargue sin excusas.
    </p>

    <div class="card" id="bibliografia">
      <div class="toolbar">
        <input id="q" type="search" placeholder="Buscar por autor, título, editorial, año, REF-…" autocomplete="off" />
        <div class="stats" id="stats">Cargando…</div>
      </div>
      <div class="toc" id="toc"></div>
      <div id="out" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <div class="mono">
        Consejo de tinta: si vas a imprimir QR, apunta a <b>…/#bibliografia</b> y escribe también la URL debajo.
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const slug = (s) => s.toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");

    function isRefLine(line){ return /^REF-\d{3}\./.test(line); }
    function isSectionLine(line){
      const t = line.trim();
      if (!t) return false;
      if (t.startsWith("REF-")) return false;
      if (t.includes(".")) return false;
      // secciones tipo MANUALES, WIKI|PODCAST|BLOG, DOCUMENTOS|ARTÍCULOS|ENTORNOS, etc.
      return t === t.toUpperCase() && !t.includes(",") && t.length <= 60;
    }
    function isAuthorLine(line){
      const t = line.trim();
      if (!t) return false;
      if (t.startsWith("REF-")) return false;
      if (isSectionLine(t)) return false;
      // Autor suele ser MAYÚSCULAS + coma (APELLIDO, Nombre) o lista con ; ,
      const upperish = (t === t.toUpperCase());
      const hasComma = t.includes(",");
      const looksLike = upperish && (hasComma || t.includes(";"));
      return looksLike;
    }

    function parseBib(text){
      const lines = text.replace(/\r/g,"").split("\n").map(l=>l.trimEnd());
      const sections = [];
      let currentSection = { name:"BIBLIOGRAFÍA", authors:[] };
      sections.push(currentSection);

      let currentAuthor = null;
      let lastItem = null;

      for (let raw of lines){
        const line = raw.trim();
        if (!line) continue;

        // saltar el epígrafe/quote si viene arriba: lo dejamos, pero no lo metemos como ítem
        if (line.startsWith("Quizás es mejor") || line.startsWith("Si el libro es malo") || line.startsWith("Si el libro es bueno")) continue;

        if (isSectionLine(line)){
          currentSection = { name: line, authors:[] };
          sections.push(currentSection);
          currentAuthor = null;
          lastItem = null;
          continue;
        }

        if (isAuthorLine(line)){
          currentAuthor = { name: line, id: slug(line), items:[] };
          currentSection.authors.push(currentAuthor);
          lastItem = null;
          continue;
        }

        if (isRefLine(line)){
          if (!currentAuthor){
            currentAuthor = { name:"SIN AUTOR (NO CLASIFICADO)", id:"sin-autor", items:[] };
            currentSection.authors.push(currentAuthor);
          }
          const m = line.match(/^(REF-\d{3})\.\s*(.*)$/);
          const item = { ref: m ? m[1] : "", text: m ? m[2] : line };
          currentAuthor.items.push(item);
          lastItem = item;
          continue;
        }

        // Continuaciones: si una línea no es autor ni ref, la pegamos al último ítem
        if (lastItem){
          lastItem.text = (lastItem.text + " " + line).replace(/\s+/g," ").trim();
        }
      }

      return sections;
    }

    function render(sections){
      const out = $("out");
      const toc = $("toc");
      out.innerHTML = "";
      toc.innerHTML = "";

      let totalItems = 0;
      let totalAuthors = 0;

      // TOC por secciones (no por cada autor, porque sería infinito)
      for (const sec of sections){
        const secId = slug(sec.name);
        const a = document.createElement("a");
        a.className = "pill";
        a.href = "#" + secId;
        a.textContent = sec.name;
        toc.appendChild(a);
      }

      for (const sec of sections){
        const secId = slug(sec.name);
        const secEl = document.createElement("section");
        secEl.id = secId;
        secEl.style.marginTop = "18px";

        const h = document.createElement("div");
        h.className = "mono";
        h.style.margin = "10px 0 6px";
        h.innerHTML = "<b>" + sec.name + "</b>";
        secEl.appendChild(h);

        for (const au of sec.authors){
          totalAuthors++;
          totalItems += au.items.length;

          const det = document.createElement("details");
          det.open = false;

          const sum = document.createElement("summary");
          const sumline = document.createElement("div");
          sumline.className = "sumline";
          sumline.innerHTML = `<span class="author" id="${au.id}">${au.name}</span><span class="count">${au.items.length} refs</span>`;
          sum.appendChild(sumline);
          det.appendChild(sum);

          const ol = document.createElement("ol");
          for (const it of au.items){
            const li = document.createElement("li");
            li.dataset.search = (au.name + " " + it.ref + " " + it.text).toLowerCase();
            li.innerHTML = `<span class="mono ref">${it.ref}</span> <span>${escapeHtml(it.text)}</span>`;
            ol.appendChild(li);
          }
          det.appendChild(ol);
          secEl.appendChild(det);
        }

        out.appendChild(secEl);
      }

      $("stats").textContent = `${totalItems} referencias · ${totalAuthors} autores/secciones`;
      hookSearch();
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    function hookSearch(){
      const q = $("q");
      const details = Array.from(document.querySelectorAll("details"));

      q.addEventListener("input", () => {
        const term = q.value.trim().toLowerCase();
        let shown = 0;

        for (const det of details){
          const items = Array.from(det.querySelectorAll("li"));
          let any = false;

          for (const li of items){
            const ok = !term || li.dataset.search.includes(term);
            li.classList.toggle("hide", !ok);
            if (ok) { any = true; shown++; }
          }

          det.classList.toggle("hide", !any);
          // abrir automáticamente si hay filtro
          if (term) det.open = any;
          else det.open = false;
        }

        if (term) $("stats").textContent = `${shown} coincidencias · filtro activo`;
        else {
          // recalcular desde DOM (simple)
          const total = document.querySelectorAll("li").length;
          const authors = document.querySelectorAll("details").length;
          $("stats").textContent = `${total} referencias · ${authors} autores/secciones`;
        }
      });
    }

    async function main(){
      // cache-buster suave para que no te quedes viendo versiones viejas
      const url = "bibliografia.txt?v=" + Date.now();
      const res = await fetch(url);
      if (!res.ok){
        $("stats").textContent = "No puedo leer bibliografia.txt (¿está en la raíz del repo?)";
        return;
      }
      const text = await res.text();
      const sections = parseBib(text);
      render(sections);

      // si viene con hash, baja a esa zona
      if (location.hash) {
        const el = document.querySelector(location.hash);
        if (el) el.scrollIntoView({ behavior:"smooth", block:"start" });
      }
    }
    main();
  </script>
</body>
</html>
