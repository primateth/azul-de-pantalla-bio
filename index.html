<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bibliografía Azul de Pantalla · Templo del dato</title>
  <meta name="description" content="Índice navegable y buscable de la bibliografía de Azul de Pantalla." />
  <style>
    :root{
      --bg:#070A10;
      --panel:#0C1220;
      --text:#E9EEF8;
      --muted:#AAB6D6;
      --line:rgba(255,255,255,.10);
      --accent:#3B82F6;
      --mark: rgba(59,130,246,.35);
      --radius:14px;
      --shadow: 0 14px 40px rgba(0,0,0,.45);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 700px at 30% -10%, rgba(59,130,246,.18), transparent 55%),
                  radial-gradient(1000px 600px at 100% 0%, rgba(29,78,216,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1220px;margin:0 auto;padding:22px 16px 30px;}
    header{
      display:flex;align-items:flex-start;justify-content:space-between;gap:16px;margin-bottom:16px;
    }
    .brand{min-width:260px;}
    .brand h1{margin:0 0 6px 0;font-size:20px;letter-spacing:.2px;font-weight:650;}
    .brand p{margin:0;color:var(--muted);font-size:13px;line-height:1.35;}
    .quote{
      margin-top:10px;padding-left:12px;border-left:2px solid rgba(59,130,246,.35);
      color:rgba(233,238,248,.90);font-size:13px;line-height:1.5;
    }
    .quote .sig{display:block;margin-top:6px;color:rgba(170,182,214,.9);font-family:var(--mono);font-size:12px;}

    .topActions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center;padding-top:2px;}
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      color:var(--text);
      padding:10px 12px;border-radius:12px;text-decoration:none;font-size:13px;
      cursor:pointer;display:inline-flex;align-items:center;gap:8px;user-select:none;
    }
    .btn:hover{border-color:rgba(255,255,255,.22)}
    .btn.primary{
      border-color: rgba(59,130,246,.55);
      background: linear-gradient(180deg, rgba(59,130,246,.25), rgba(59,130,246,.08));
    }
    .btn.primary:hover{border-color: rgba(59,130,246,.75)}
    .btn.ghost{background: transparent;}
    .btn:disabled, .btn.disabled{opacity:.55;cursor:not-allowed;filter:saturate(.7);}

    .grid{display:grid;grid-template-columns: 320px 1fr;gap:14px;align-items:start;}
    aside, main{
      background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    aside{padding:14px;position:sticky;top:14px;max-height: calc(100vh - 28px);overflow:auto;}
    main{padding:14px;overflow:hidden;}

    .field{display:flex;flex-direction:column;gap:8px;margin-bottom:12px;}
    .labelRow{display:flex;justify-content:space-between;align-items:baseline;gap:10px;}
    label{font-size:12px;color:var(--muted);}
    .hint{font-size:11px;color:rgba(170,182,214,.75);font-family:var(--mono);}
    input[type="text"], select{
      width:100%;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(3,7,18,.55);
      color:var(--text);
      padding:10px 10px;border-radius:12px;outline:none;font-size:13px;
    }
    input[type="text"]::placeholder{color: rgba(170,182,214,.65)}
    input[type="text"]:focus, select:focus{
      border-color: rgba(59,130,246,.75);
      box-shadow: 0 0 0 3px rgba(59,130,246,.15);
    }

    .rowActions{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 14px;}
    .rowActions .btn{flex:1;justify-content:center;min-width:130px;}

    .navBlockTitle{
      margin:14px 0 6px;font-size:12px;color:rgba(233,238,248,.9);
      letter-spacing:.35px;text-transform:uppercase;
    }
    .navList{display:flex;flex-direction:column;gap:6px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,.08);}
    .navList:last-child{border-bottom:none}
    .navItem{
      text-decoration:none;border:1px solid rgba(255,255,255,.10);
      background: rgba(3,7,18,.35);
      padding:9px 10px;border-radius:12px;font-size:13px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .navItem:hover{border-color: rgba(255,255,255,.18)}
    .navItem small{
      color: rgba(170,182,214,.85);
      font-family:var(--mono);font-size:11px;white-space:nowrap;
    }

    .metaBar{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;color:rgba(170,182,214,.85);font-size:12px;}
    .pill{
      border:1px solid rgba(255,255,255,.12);
      padding:6px 8px;border-radius:999px;background: rgba(3,7,18,.35);
      font-family:var(--mono);
    }

    .status{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(3,7,18,.35);
      border-radius:12px;padding:10px 12px;
      color:rgba(170,182,214,.92);font-size:13px;margin-bottom:12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .status strong{color:rgba(233,238,248,.95)}
    .status code{
      font-family:var(--mono);font-size:12px;color:rgba(233,238,248,.9);
      background: rgba(59,130,246,.10);
      border:1px solid rgba(59,130,246,.20);
      padding:2px 6px;border-radius:8px;
    }

    .content{display:flex;flex-direction:column;gap:10px;}

    /* Bloque wrapper para que tu setupSearch funcione igual */
    .block{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(3,7,18,.35);
      border-radius: 14px;
      overflow:hidden;
    }

    details.group{border:none;background:transparent;border-radius:0;overflow:hidden;}
    details.group[open]{outline:1px solid rgba(59,130,246,.35); outline-offset:-1px;}

    summary{
      list-style:none;cursor:pointer;padding:12px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;user-select:none;
    }
    summary::-webkit-details-marker{display:none}
    .sumLeft{display:flex;flex-direction:column;gap:2px;min-width:0;}
    .sumTitle{
      font-weight:650;font-size:14px;letter-spacing:.2px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .sumType{color:rgba(170,182,214,.85);font-size:12px;font-family:var(--mono);}
    .sumRight{display:flex;align-items:center;gap:10px;flex-shrink:0;}
    .range{
      font-family:var(--mono);font-size:12px;color:rgba(233,238,248,.9);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:4px 8px;border-radius:999px;white-space:nowrap;
    }

    .body{padding: 0 12px 12px;}
    .lines{margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:7px;}
    .line{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(3,7,18,.28);
      border-radius:12px;
      padding:9px 10px;
      font-size:13px;line-height:1.35;
      color:rgba(233,238,248,.93);
      word-break:break-word;
    }
    .line a{
      color: rgba(147,197,253,.95);
      text-decoration: underline;
      text-decoration-thickness: 1px;
      text-underline-offset: 2px;
    }

    /* Subapartados dentro de secciones (NO crean bloque nuevo) */
    .subhead{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      border-radius:12px;
      padding:8px 10px;
      font-size:12px;
      font-family:var(--mono);
      color:rgba(233,238,248,.90);
      letter-spacing:.35px;
      text-transform:uppercase;
    }

    .footerNote{
      margin-top:12px;color:rgba(170,182,214,.85);
      font-size:12px;border-top:1px solid rgba(255,255,255,.08);
      padding-top:12px;line-height:1.45;
    }
    .footerNote code{
      font-family:var(--mono);font-size:12px;padding:2px 6px;border-radius:8px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:rgba(233,238,248,.92);
    }

    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
      aside{position:relative; top:auto; max-height:none}
      header{flex-direction:column}
      .topActions{justify-content:flex-start}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>Bibliografía <span style="color:rgba(147,197,253,.95)">Azul de Pantalla</span> · <span style="color:rgba(170,182,214,.95)">Templo del dato</span></h1>
        <p>Índice navegable desde <code style="font-family:var(--mono);font-size:12px">bibliografia.txt</code> en el repositorio.</p>
        <div class="quote">
          Quizás es mejor la bibliografía que el propio libro.<br>
          Si el libro es malo, la bibliografía siempre queda bien.<br>
          Si el libro es bueno, la bibliografía se atribuye el mérito.
          <span class="sig">© M. MÜLLER</span>
        </div>
      </div>

      <div class="topActions">
        <a id="btnRepo" class="btn" href="#" target="_blank" rel="noopener">Repo</a>
        <a id="btnRaw" class="btn" href="#" target="_blank" rel="noopener">Ver bibliografia.txt</a>
        <a id="btnBuy" class="btn primary disabled" href="#" target="_blank" rel="noopener">Compra (provisional)</a>
        <a class="btn" href="mailto:mercurius81@proton.me">Contacto</a>
        <a class="btn" href="bibliografia.txt" download="bibliografia.txt">Descargar TXT</a>
      </div>
    </header>

    <div class="grid">
      <aside>
        <div class="field">
          <div class="labelRow">
            <label for="search">Buscar</label>
            <span class="hint">autor · sección · REF · título</span>
          </div>
          <input type="text" id="search" placeholder="Ej: Foucault, REF-152, Podcasts, 'Vigilar y castigar'…" />
        </div>

        <div class="field">
          <div class="labelRow">
            <label for="jumpSelect">Saltar a…</label>
            <span class="hint">autor / sección + rango REF</span>
          </div>
          <select id="jumpSelect">
            <option value="">Selecciona</option>
          </select>
        </div>

        <div class="rowActions">
          <button id="btnExpandAll" class="btn ghost" type="button">Abrir todo</button>
          <button id="btnCollapseAll" class="btn ghost" type="button">Cerrar todo</button>
        </div>

        <div class="rowActions">
          <button id="btnRenumber" class="btn" type="button" title="Renumeración local: genera un TXT nuevo y lo descarga">Renumerar + Descargar</button>
          <button id="btnClear" class="btn" type="button">Limpiar búsqueda</button>
        </div>

        <div class="navBlockTitle">Autores</div>
        <div id="authorsList" class="navList"></div>

        <div class="navBlockTitle">Secciones</div>
        <div id="sectionsList" class="navList"></div>

        <div class="metaBar">
          <span class="pill" id="metaGroups">grupos: …</span>
          <span class="pill" id="metaRefs">refs: …</span>
        </div>
      </aside>

      <main>
        <div class="status" id="status">
          <div><strong>Estado:</strong> cargando <code>bibliografia.txt</code></div>
          <div class="hint" id="statusHint"></div>
        </div>

        <div id="content" class="content"></div>

        <div class="footerNote">
          Sube <code>index.html</code> + <code>bibliografia.txt</code> al repo. Si GitHub Pages no encuentra el archivo,
          revisa mayúsculas/minúsculas (Linux es estricto). El botón <code>Renumerar + Descargar</code> no toca tu repo: genera un archivo local.
        </div>
      </main>
    </div>
  </div>

<script>
/* ==========
   CONFIG
   ========== */

// Link de compra provisional (cuando lo tengas). Si está vacío, se desactiva.
const BUY_URL = ""; // ej: "https://amazon.es/dp/XXXX"

// Candidatos por si el archivo se llama distinto (case/acentos)
const FILE_CANDIDATES = [
  "bibliografia.txt",
  "Bibliografia.txt",
  "BIBLIOGRAFIA.TXT",
  "bibliografía.txt",
  "Bibliografía.txt"
];

// Secciones MAYORES: SOLO estas crean bloque propio al final.
const MAJOR_SECTION_TITLES = new Set([
  "PODCASTS",
  "BLOGS",
  "MANUALES",
  "TEXTOS RELIGIOSOS",
  "IDEOLOGÍAS / DOCTRINAS DE MANDO (POLÍTICA Y RÉGIMEN)",
  "IDEOLOGÍAS (CARTOGRAFÍA HISTÓRICA)",
  "CONTRAPESOS / HISTORIOGRAFÍA CRÍTICA",
  "ANTI-TECNOLOGÍA (OBJETOS HISTÓRICOS)",
  "CRÍTICA DE LA TÉCNICA (CANON)",
  "RADICALISMOS ANTI-CIVILIZACIÓN (CARTOGRAFÍA)"
]);

/* ==========
   DOM
   ========== */
const els = {
  btnRepo: document.getElementById("btnRepo"),
  btnRaw: document.getElementById("btnRaw"),
  btnBuy: document.getElementById("btnBuy"),
  search: document.getElementById("search"),
  jump: document.getElementById("jumpSelect"),
  authorsList: document.getElementById("authorsList"),
  sectionsList: document.getElementById("sectionsList"),
  content: document.getElementById("content"),
  status: document.getElementById("status"),
  statusHint: document.getElementById("statusHint"),
  metaGroups: document.getElementById("metaGroups"),
  metaRefs: document.getElementById("metaRefs"),
  btnExpandAll: document.getElementById("btnExpandAll"),
  btnCollapseAll: document.getElementById("btnCollapseAll"),
  btnRenumber: document.getElementById("btnRenumber"),
  btnClear: document.getElementById("btnClear")
};

/* ==========
   Helpers
   ========== */
const pad3 = (n) => String(n).padStart(3, "0");

const escapeHTML = (s) =>
  s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");

const extractRefs = (s) => {
  const refs = [];
  const re = /REF-(\d+)(?:[_-]\d+)?/gi;
  let m;
  while ((m = re.exec(s)) !== null) refs.push(parseInt(m[1],10));
  return refs;
};

const refRangeLabel = (min,max) => {
  if(!Number.isFinite(min) || !Number.isFinite(max)) return "";
  if(min===max) return `REF-${pad3(min)}`;
  return `REF-${pad3(min)}–REF-${pad3(max)}`;
};

const linkify = (text) => {
  const urlRe = /(https?:\/\/[^\s)]+)|(www\.[^\s)]+)/gi;
  return text.replace(urlRe, (m) => {
    const href = m.startsWith("http") ? m : `https://${m}`;
    return `<a href="${escapeHTML(href)}" target="_blank" rel="noopener">${escapeHTML(m)}</a>`;
  });
};

const isRefLine = (t) => /^REF-\d+/i.test(t);
const isLinkLine = (t) => /^(Link|PDF)\s*:/i.test(t);
const isUrlLine  = (t) => /^https?:\/\//i.test(t);

const isAllCapsish = (t) => {
  // “capsish”: tolera tildes y signos
  const letters = t.replace(/[^A-Za-zÁÉÍÓÚÜÑáéíóúüñ]/g,"");
  if(!letters) return false;
  // si hay minúsculas “de verdad”, no es capsish
  const hasLower = /[a-záéíóúüñ]/.test(letters);
  const hasUpper = /[A-ZÁÉÍÓÚÜÑ]/.test(letters);
  return hasUpper && !hasLower;
};

// Autor heading en la parte principal
const isAuthorHeading = (t) => {
  if(!t) return false;
  if(isRefLine(t) || isLinkLine(t) || isUrlLine(t)) return false;
  // autor suele tener coma o ser capsish (EMPÉDOCLES, EPICURO, etc.)
  return t.includes(",") || isAllCapsish(t);
};

// Subapartado dentro de secciones (no bloque nuevo)
const isSectionSubhead = (t) => {
  if(!t) return false;
  if(isRefLine(t) || isLinkLine(t) || isUrlLine(t)) return false;
  if(MAJOR_SECTION_TITLES.has(t)) return false;
  // típicos: AUDIOLIBROS, IVOOX / PROGRAMAS, EPIC GAMES, ANÓNIMOS, etc.
  return isAllCapsish(t) || t.includes("/") || t.includes("—");
};

/* ==========
   Repo links (auto)
   ========== */
function computeRepoURLs(){
  // Intenta deducir user/repo si es GitHub Pages: https://user.github.io/repo/
  const host = location.hostname;
  const pathParts = location.pathname.split("/").filter(Boolean);
  const isGhPages = host.endsWith("github.io") && pathParts.length >= 1;
  const user = isGhPages ? host.split(".")[0] : null;
  const repo = isGhPages ? pathParts[0] : null;

  const repoUrl = (user && repo) ? `https://github.com/${user}/${repo}` : "#";
  const rawUrl  = (user && repo) ? `${repoUrl}/blob/main/` : "#";

  return { repoUrl, rawBase: rawUrl };
}

/* ==========
   Fetch with fallback
   ========== */
async function fetchFirstAvailable(paths){
  const tried = [];
  for(const p of paths){
    tried.push(p);
    try{
      const res = await fetch(p, {cache:"no-store"});
      if(res.ok){
        const txt = await res.text();
        return { ok:true, path:p, text:txt, tried };
      }
    }catch(e){
      // sigue probando
    }
  }
  return { ok:false, path:null, text:"", tried };
}

/* ==========
   Parse: autores (bloques) + secciones mayores (bloques)
   Dentro de secciones: subheads como líneas especiales.
   ========== */
function parseBibliography(raw){
  const lines = raw.replace(/\r\n/g,"\n").split("\n");
  const authors = [];
  const sections = [];

  let mode = "authors"; // authors -> sections
  let current = null;

  function pushCurrent(){
    if(!current) return;
    // limpia vacíos finales
    while(current.items.length && current.items[current.items.length-1].text.trim()==="") current.items.pop();

    const allText = current.items.map(i=>i.text).join("\n");
    const refs = extractRefs(allText);
    current.refMin = refs.length ? Math.min(...refs) : null;
    current.refMax = refs.length ? Math.max(...refs) : null;
    current.refCount = refs.length;

    (current.type==="author" ? authors : sections).push(current);
    current = null;
  }

  function startGroup(type, title){
    pushCurrent();
    const idx = (type==="author" ? authors.length : sections.length) + 1;
    current = {
      id: `${type==="author" ? "auth" : "sec"}-${pad3(idx)}`,
      type,
      title,
      items: []
    };
  }

  for(const rawLine of lines){
    const line = rawLine;
    const t = line.trim();

    if(!t) continue;

    if(mode==="authors"){
      if(MAJOR_SECTION_TITLES.has(t)){
        // entra en modo secciones
        pushCurrent();
        mode = "sections";
        startGroup("section", t);
        continue;
      }
      if(isAuthorHeading(t)){
        startGroup("author", t);
        continue;
      }
      if(!current){
        // ignora preámbulos si llegan antes del primer autor
        continue;
      }
      current.items.push({ kind:"line", text: line });
    }else{
      // mode sections: SOLO títulos mayores crean nuevo bloque
      if(MAJOR_SECTION_TITLES.has(t)){
        startGroup("section", t);
        continue;
      }
      if(!current){
        // si por lo que sea falta sección, crea una genérica
        startGroup("section", "SECCIONES");
      }

      if(isSectionSubhead(t)){
        current.items.push({ kind:"subhead", text: t });
      }else{
        current.items.push({ kind:"line", text: line });
      }
    }
  }

  pushCurrent();

  // Autores: orden alfabético suave (por si se desordena al añadir)
  authors.sort((a,b)=>a.title.localeCompare(b.title, "es", {sensitivity:"base"}));

  // Recalcula ids tras ordenar autores
  authors.forEach((g,i)=> g.id = `auth-${pad3(i+1)}`);

  return { authors, sections, all:[...authors, ...sections], raw };
}

/* ==========
   Render
   ========== */
function renderAll(model){
  els.content.innerHTML = "";
  els.authorsList.innerHTML = "";
  els.sectionsList.innerHTML = "";
  els.jump.innerHTML = `<option value="">Selecciona</option>`;

  const allGroups = model.all;
  const totalGroups = allGroups.length;
  const totalRefs = allGroups.reduce((acc,g)=>acc + (g.refCount||0), 0);
  els.metaGroups.textContent = `grupos: ${totalGroups}`;
  els.metaRefs.textContent = `refs: ${totalRefs}`;

  function addNavItem(container, g){
    const a = document.createElement("a");
    a.href = `#${g.id}`;
    a.className = "navItem";
    a.dataset.groupId = g.id;
    a.innerHTML = `<span>${escapeHTML(g.title)}</span><small>${escapeHTML(refRangeLabel(g.refMin,g.refMax) || "")}</small>`;
    a.addEventListener("click",(ev)=>{
      ev.preventDefault();
      const el = document.getElementById(g.id);
      if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
      const det = el ? el.querySelector("details") : null;
      if(det) det.open = true;
    });
    container.appendChild(a);
  }

  function addJumpOption(g){
    const range = refRangeLabel(g.refMin,g.refMax) || "—";
    const opt = document.createElement("option");
    opt.value = g.id;
    opt.textContent = `${g.title} · ${range}`;
    els.jump.appendChild(opt);
  }

  // Nav: autores
  for(const g of model.authors){
    addJumpOption(g);
    addNavItem(els.authorsList, g);
  }
  // Nav: secciones
  for(const g of model.sections){
    addJumpOption(g);
    addNavItem(els.sectionsList, g);
  }

  // Content blocks
  for(const g of allGroups){
    const block = document.createElement("section");
    block.className = "block";
    block.id = g.id;

    const details = document.createElement("details");
    details.className = "group";

    const typeLabel = (g.type==="author") ? "autor" : "sección";
    const range = refRangeLabel(g.refMin,g.refMax) || "—";

    const summary = document.createElement("summary");
    summary.innerHTML = `
      <div class="sumLeft">
        <div class="sumTitle">${escapeHTML(g.title)}</div>
        <div class="sumType">${escapeHTML(typeLabel)}</div>
      </div>
      <div class="sumRight">
        <span class="range">${escapeHTML(range)}</span>
      </div>
    `;

    const body = document.createElement("div");
    body.className = "body";

    const ul = document.createElement("ul");
    ul.className = "lines";

    for(const item of g.items){
      if(item.kind==="subhead"){
        const li = document.createElement("li");
        li.className = "subhead";
        li.textContent = item.text;
        ul.appendChild(li);
        continue;
      }

      const rawLine = item.text;
      const li = document.createElement("li");
      li.className = "line";
      li.innerHTML = linkify(escapeHTML(rawLine));
      ul.appendChild(li);
    }

    body.appendChild(ul);
    details.appendChild(summary);
    details.appendChild(body);

    block.appendChild(details);
    els.content.appendChild(block);
  }
}

/* ==========
   TU setupSearch (con mini-fix para abrir details si el ID está en el wrapper)
   + filtra también nav lateral (sin romper tu lógica)
   ========== */
function setupSearch(){
  const search = document.getElementById("search");
  const jump = document.getElementById("jumpSelect");

  // Filtra:
  // 1) el desplegable (autor/sección/REF-range)
  // 2) los bloques renderizados (incluye títulos de obras dentro de cada REF)
  search.addEventListener("input", ()=>{
    const q = search.value.trim().toLowerCase();

    // (A) Filtrar opciones del select (autor/sección/REF-range)
    const opts = jump.querySelectorAll("option");
    for(const opt of opts){
      if(!opt.value) continue;
      opt.hidden = q ? !opt.textContent.toLowerCase().includes(q) : false;
    }

    // (B) Filtrar bloques del contenido (incluye texto de entradas = títulos/obras)
    const content = document.getElementById("content");
    const blocks = Array.from(content.children);

    if(!q){
      for(const b of blocks) b.style.display = "";
      // nav
      document.querySelectorAll(".navItem").forEach(n=>n.style.display="");
      els.statusHint.textContent = "";
      return;
    }

    let shown = 0;
    for(const b of blocks){
      const hay = (b.innerText || b.textContent || "").toLowerCase();
      const ok = hay.includes(q);
      b.style.display = ok ? "" : "none";
      if(ok) shown++;
    }

    // nav lateral: solo lo visible
    document.querySelectorAll(".navItem").forEach(n=>{
      const id = n.dataset.groupId;
      const el = document.getElementById(id);
      const visible = el && el.style.display !== "none";
      n.style.display = visible ? "" : "none";
    });

    els.statusHint.textContent = `coincidencias: mostrando ${shown} bloque(s)`;
  });

  jump.addEventListener("change", ()=>{
    const id = jump.value;
    if(!id) return;
    const el = document.getElementById(id);
    if(!el) return;
    el.scrollIntoView({behavior:"smooth", block:"start"});
    const det = el.querySelector("details") || (el.matches("details") ? el : null);
    if(det) det.open = true;
  });
}

/* ==========
   Expand/Collapse + Clear
   ========== */
function setupUIButtons(){
  els.btnExpandAll.addEventListener("click", ()=>{
    document.querySelectorAll("details.group").forEach(d=>{
      const wrapper = d.closest(".block");
      if(wrapper && wrapper.style.display==="none") return;
      d.open = true;
    });
  });

  els.btnCollapseAll.addEventListener("click", ()=>{
    document.querySelectorAll("details.group").forEach(d=> d.open = false);
  });

  els.btnClear.addEventListener("click", ()=>{
    els.search.value = "";
    els.search.dispatchEvent(new Event("input"));
    els.search.focus();
  });
}

/* ==========
   Renumber local download (REF-###_# -> REF-### secuencial)
   ========== */
function setupRenumber(rawText){
  els.btnRenumber.addEventListener("click", ()=>{
    let i = 1;
    const out = rawText.replace(/REF-(\d+)(?:[_-]\d+)?/gi, ()=>{
      const v = `REF-${pad3(i)}`;
      i++;
      return v;
    });

    const blob = new Blob([out], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "bibliografia_renumerada.txt";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });
}

/* ==========
   Buy button + Repo button
   ========== */
function setupTopLinks(foundPath){
  const { repoUrl } = computeRepoURLs();

  if(repoUrl !== "#"){
    els.btnRepo.href = repoUrl;
  }else{
    els.btnRepo.classList.add("disabled");
    els.btnRepo.addEventListener("click",(e)=>e.preventDefault());
  }

  // link directo al archivo en el sitio (no raw github)
  els.btnRaw.href = foundPath || "bibliografia.txt";

  if(BUY_URL && BUY_URL.trim() && BUY_URL !== "#"){
    els.btnBuy.href = BUY_URL.trim();
    els.btnBuy.classList.remove("disabled");
  }else{
    els.btnBuy.classList.add("disabled");
    els.btnBuy.setAttribute("aria-disabled","true");
    els.btnBuy.addEventListener("click",(e)=>e.preventDefault());
    els.btnBuy.title = "Edita BUY_URL en el código para activar la compra provisional.";
  }
}

/* ==========
   Init
   ========== */
(async function init(){
  setupUIButtons();

  // Intentar cargar bibliografia.txt (con fallbacks)
  const result = await fetchFirstAvailable(FILE_CANDIDATES);

  if(!result.ok){
    els.status.innerHTML = `<div><strong>Estado:</strong> no se pudo cargar <code>bibliografia.txt</code></div>
      <div class="hint">Probados: ${escapeHTML(result.tried.join(", "))}</div>`;
    // Deja enlaces mínimos
    setupTopLinks("bibliografia.txt");
    return;
  }

  const raw = result.text;
  const model = parseBibliography(raw);

  renderAll(model);
  setupSearch();
  setupRenumber(raw);
  setupTopLinks(result.path);

  els.status.innerHTML = `<div><strong>Estado:</strong> listo · leyendo <code>${escapeHTML(result.path)}</code></div><div class="hint" id="statusHint"></div>`;
  els.statusHint = document.getElementById("statusHint");
})();
</script>
</body>
</html>
